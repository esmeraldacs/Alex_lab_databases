---
title: "Untitled"
output: html_document
date: "2024-11-21"
---

```{r}
library(tidyverse)
```




```{r}
#na.strings = c("", "NA") will treat both empty strings and "NA" as NA values.
#check.names = FALSE column names are kept as they are in the CSV, without automatic changes like replacing spaces or special characters.
pmodern0 <- read.csv("Pmodern (1).csv", check.names = FALSE, na.strings = c("", "NA"))

# If we examine, with the line below, the column names of pmodern0, we will find 7 duplicated columns. 
# In the pmodern0 dataframe, the duplicates appear as if they have the '.1' suffix added virtually, 
# but the column names are not actually modified. The line below detects these duplicated column names.
names(pmodern0)[duplicated(names(pmodern0)) | duplicated(names(pmodern0), fromLast = TRUE)]

# This line actually adds a suffix, in this case, "_1", to the duplicated column names.
# After applying `make.unique`, if we check for duplicates again, we will see there are no duplicates because the suffix has been added to resolve them.
names(pmodern0) <- make.unique(names(pmodern0), sep = "_")
#names(pmodern0)[duplicated(names(pmodern0)) | duplicated(names(pmodern0), fromLast = TRUE)]

#To see in which column names the suffix was added
#grep("\\_1$", names(pmodern0), value = TRUE)
```

Creating a single column from the duplicates

```{r}
pmodern1 <- pmodern0 |>
  mutate(Cayaponia = Cayaponia + Cayaponia_1,
         Cupania = Cupania + Cupania_1,
         Symphonia = Symphonia + Symphonia_1,
         Daphnopsis = Daphnopsis + Daphnopsis_1,
         Gomphrena = Gomphrena + Gomphrena_1,
         Symmeria = Symmeria + Symmeria_1,
         Xylosma = Xylosma + Xylosma_1) |>
  select(-c(Cayaponia_1, Cupania_1, Symphonia_1, Daphnopsis_1, Gomphrena_1, Symmeria_1, Xylosma_1)) |>
  mutate(`Combretaceae/Melastomataceae` =  `Combretaceae/Melastomataceae` + Combretaceae,
         Salicaceae = Salicaceae + Flacourtiaceae) |> #sum the Combretaceae to the Combretaceae/Melastomataceae
  select(-c(Combretaceae, Flacourtiaceae)) |>
  rename(Fabaceae = FabPapil)
  
#Look for the persistence of duplicates
#names(pmodern1)[duplicated(names(pmodern1)) | duplicated(names(pmodern1), fromLast = TRUE)]

# Check if columns with the _1 suffix still exist
#grep("\\_1$", names(pmodern1), value = TRUE)
```


Removing empty rows and knowing how many ID values are missing from the sequence
```{r}
pmodern1 <- pmodern1 |>
  filter(!is.na(ID))


setdiff(seq(1, max(pmodern1$ID)), pmodern1$ID)
```

Adding a column 
```{r}
#Pivot longor to re-pivot wider to order the taxa alphabetically
pmodern2 <- pmodern1 |>
  pivot_longer(cols = -c(ID:Elevation)) |>
  arrange(name) |>
  pivot_wider(id_cols = c(ID:Elevation)) |>
  mutate(suma = rowSums(across(Abies:Zollernia), na.rm = TRUE))

pmodern2 |>
  select(suma) |>
  ggplot() +
  geom_histogram(aes(x=suma), binwidth = 0.5)
```


```{r}
pmodern2 <- pmodern1 |>
  pivot_longer(cols = -c(ID:Elevation)) |>
  filter(value > 0) |>
  group_by(ID) |>
  mutate(suma = sum(value)) |>
  mutate(value = case_when(suma > 50 ~ value/100, TRUE ~ value)) |>
  mutate(suma = sum(value)) |>
  ungroup() #|>
#  arrange(name) |>
#  pivot_wider(id_cols = c(ID:Elevation), values_fill = 0) |>
#  mutate(suma = rowSums(across(Abies:Zollernia), na.rm = TRUE))
  

pmodern2 |>
  filter(suma < 0.95 ) |>
  select(ID, sample,suma) |>
  distinct() 


pmodern2 <- pmodern2 |>
  group_by(ID) |>
  mutate(value = case_when(suma < 0.95 ~ ((value /sum(value))*1), TRUE ~ value)) |>
  mutate(suma = sum(value)) |>
  ungroup()
```










